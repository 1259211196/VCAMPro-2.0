name: Build VCAM Dylib
on: [push, workflow_dispatch]
jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Theos
        uses: actions/checkout@v4
        with:
          repository: theos/theos
          path: theos
          submodules: recursive
          
      - name: Setup iOS SDK
        run: |
          rm -rf theos/sdks
          git clone https://github.com/theos/sdks.git theos/sdks
          
      # ðŸŒŸ ä¼˜åŒ–ï¼šæ—¢ç„¶ä¸éœ€è¦æ‰“åŒ… debï¼Œå°±ä¸å†éœ€è¦å®‰è£… dpkg å’Œ xzï¼Œåªä¿ç•™ ldid ç”¨äºŽç»™ dylib ç­¾å
      - name: Install Dependencies
        run: brew install ldid
          
      - name: Build Tweak (Dylib Only)
        run: |
          export THEOS=${{ github.workspace }}/theos
          # ðŸŒŸ ä¼˜åŒ–ï¼šå°† 'make package' æ”¹ä¸º 'make'ã€‚è¿™æ · Theos åªä¼šç¼–è¯‘å‡ºåŒæž¶æž„çš„ dylibï¼Œä¸ä¼šåŽ»æ‰§è¡Œè€—æ—¶çš„æ‰“åŒ…æ“ä½œ
          make FINALPACKAGE=1 messages=yes
          
      - name: Prepare Injection Artifacts
        run: |
          mkdir -p Dylib_Output
          # ðŸŒŸ æ ¸å¿ƒï¼šä»Ž Theos çš„éšè—ç¼–è¯‘ç¼“å­˜ç›®å½•ä¸­æå–ç¼–è¯‘å¥½çš„èƒ–äºŒè¿›åˆ¶ (Fat Binary) dylib
          cp .theos/obj/AVMediaSupport.dylib Dylib_Output/
          
          # æå–å¯¹åº”çš„ plist æ–‡ä»¶ï¼ˆå¦‚æžœä½ çš„é¡¹ç›®æ ¹ç›®å½•æœ‰ VCAM.plistï¼‰ã€‚
          # å·¨é­”æ³¨å…¥å™¨é€šå¸¸éœ€è¦è¿™ä¸ª plist æ–‡ä»¶æ¥è¯†åˆ«éœ€è¦æ³¨å…¥çš„ Bundle ID (å¦‚ com.zhiliaoapp.musically)
          cp *.plist Dylib_Output/ 2>/dev/null || true
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VCAM-Injectable-Dylib
          path: Dylib_Output/
